package nsu.sber.voiceassistant.service.prompt;

public class PromptFactory {

    public static String BuildPromptForInvalidAddItem(String menu) {
        return String.format(
                "Пользователь хочет добавить несколько блюд в корзину. " +
                        "Проанализируй текст пользователя и вытащи КАЖДОЕ блюдо и его размер.\n\n" +

                        "Меню:\n%s\n\n" +

                        "Твоя задача:\n" +
                        "1. Найди все блюда, которые упомянуты пользователем.\n" +
                        "2. Для каждого блюда верни точно поле itemId.\n" +
                        "3. Для каждого блюда верни точно поле sizeId.\n" +
                        "   - Если размер не указан, верни null (строкой, без кавычек).\n" +
                        "   - Если у блюда в меню нет размеров, верни 'нету' (строкой, в кавычках).\n" +
                        "4. Если блюдо не найдено в меню, itemId = null (строкой, без кавычек).\n\n" +

                        "Ответ должен быть строго в формате JSON, строго с полями 'itemId' и 'sizeId', " +
                        "все элементы массива items должны быть заполнены, даже если значением null:\n" +
                        "{\n" +
                        "  \"items\": [\n" +
                        "    { \"itemId\": null, \"sizeId\": null }\n" +
                        "  ]\n" +
                        "}\n\n" +

                        "Никаких других полей, никаких других вариантов написания, никаких itemid или sizeid — " +
                        "только itemId и sizeId строго так, с точным регистром.\n",
                menu
        );
    }





    public static String BuildPromptForInvalidRemoveItem(String menu) {
        return String.format(
                "Пользователь хочет удалить блюдо из корзины. " +
                        "Проанализируй текст пользователя и сопоставь его с блюдами из меню, чтобы определить itemId и sizeId.\n\n" +
                        "Меню:\n%s\n\n" +
                        "Твоя задача:\n" +
                        "1. Найди блюдо, которое написал пользователь.\n" +
                        "2. Определи itemId этого блюда.\n" +
                        "3. Определи sizeId выбранного размера. Если размер не указан или не найден, верни null.\n\n" +
                        "Ответ должен быть ТОЛЬКО в JSON формате, без текста, без пояснений.\n" +
                        "Структура JSON:\n" +
                        "{\n" +
                        "  \"itemId\": \"string или null\",\n" +
                        "  \"sizeId\": \"string или null\"\n" +
                        "}\n\n" +
                        "Пример:\n" +
                        "{\n" +
                        "  \"itemId\": \"568134e2-883e-4668-82e2-3dde9fb28bf4\",\n" +
                        "  \"sizeId\": \"16034385-a22b-47c7-8c43-bba2696b65c6\"\n" +
                        "}\n\n" +
                        "Если блюдо не найдено, верни null для itemId.\n" +
                        "Если размер не найден или не указан, верни null для sizeId.\n",
                menu
        );
    }

    public static String BuildPromptMappingCommand() {
        return """
            Ты — интеллектуальный ассистент ресторана, который анализирует запросы гостей и определяет их намерения.

            ТВОЯ ЗАДАЧА:
            Проанализировать текст пользователя и вернуть строго валидный JSON с намерением, уверенностью и списком сущностей.

            ДОСТУПНЫЕ НАМЕРЕНИЯ (intents):
            - ADD_ITEM: добавить блюдо в заказ
            - REMOVE_ITEM: удалить блюдо из заказа
            - CHANGE_QUANTITY: изменить количество блюда
            - SHOW_CART: показать текущий заказ
            - CHECKOUT: оформить заказ
            - CALL_WAITER: позвать официанта
            - REQUEST_BILL: попросить счет
            - UNKNOWN: неизвестное намерение
            - GET_MENU: показать меню
            - GET_INFO_DISH: получить информацию о блюде
            - GET_ADVICE: дать совет пользователю

            ПРАВИЛА ФОРМИРОВАНИЯ JSON:
            1. Ответ — ТОЛЬКО валидный JSON, без какого-либо текста, комментариев или пояснений.
            2. Структура всегда одна и та же:
               {
                 "intent": "...",
                 "confidence": 0.95,
                 "entities": [
                   {
                     "dish_name": "...",
                     "quantity": 1
                   }
                 ],
                 "response": "..."
               }
            3. Поле "entities" ВСЕГДА массив, даже если сущность одна.
            4. Каждый объект в массиве ОБЯЗАН быть полностью закрыт фигурными скобками {}.
            5. Если количество блюда явно не указано — используй quantity = 1.
            6. Все строки должны быть заключены в двойные кавычки.
            7. JSON должен быть синтаксически корректным: никаких лишних запятых, пропущенных скобок, незакрытых объектов и т.д.

            ПРИМЕР ВАЛИДНОГО МНОГОБЛЮДНОГО ОТВЕТА:
            {
              "intent": "GET_INFO_DISH",
              "confidence": 0.95,
              "entities": [
                {
                  "dish_name": "Пицца Маргарита",
                  "quantity": 1
                },
                {
                  "dish_name": "Суп Том Ям",
                  "quantity": 1
                }
              ],
              "response": "Сейчас расскажу!"
            }

            ВЕРНИ ТОЛЬКО JSON. Никакого пролога, эпилога или описаний.
            """;
    }


    public static String buildPromptForDishRecognition(String menu, String userText) {
        return """
        Пользователь хочет получить подробную информацию о блюде.
        Определи, какое именно блюдо имеется в виду, используя меню.

        Меню:
        %s

        Текст пользователя:
        "%s"

        Твоя задача:
        1. Найди блюдо, наиболее соответствующее запросу пользователя.
        2. Верни только JSON в формате:
        {
          "itemId": "string или null"
        }

        Если блюдо не найдено — верни:
        {
          "itemId": null
        }

        Никаких пояснений, примечаний и текста — только JSON.
        """.formatted(menu, userText);
    }

    public static String buildPromptForGetDishId(String menu, String dishName) {
        return String.format(
                "Определи ID блюда по его названию.\n\n" +

                        "Меню:\n%s\n\n" +

                        "Название блюда от пользователя:\n\"%s\"\n\n" +

                        "Твоя задача:\n" +
                        "1. Найти блюдо, наиболее точно соответствующее названию пользователя.\n" +
                        "2. Вернуть ТОЛЬКО валидный JSON строго следующей структуры:\n" +
                        "{\n" +
                        "  \"items\": [\n" +
                        "    {\n" +
                        "      \"itemId\": \"string или null\"\n" +
                        "    }\n" +
                        "  ]\n" +
                        "}\n\n" +

                        "Правила:\n" +
                        "- Корневой объект ДОЛЖЕН содержать ТОЛЬКО поле \"items\".\n" +
                        "- \"items\" — это ВСЕГДА массив, даже если блюдо одно.\n" +
                        "- Каждый объект внутри массива ДОЛЖЕН содержать ТОЛЬКО одно поле: \"itemId\".\n" +
                        "- Если блюдо не найдено, верни:\n" +
                        "{\n" +
                        "  \"items\": [\n" +
                        "    {\n" +
                        "      \"itemId\": null\n" +
                        "    }\n" +
                        "  ]\n" +
                        "}\n\n" +
                        "Жёсткое требование:\n" +
                        "Возвращай ТОЛЬКО JSON. Никакого текста, комментариев или пояснений.",
                menu,
                dishName
        );
    }

    public static String buildAdvicePrompt(String menu, String context) {
        return String.format(
                """
                Ты — интеллектуальный ассистент ресторана. 
                Твоя задача — дать полезный, краткий и человеческий совет гостю на основе меню и контекста.
    
                МЕНЮ:
                %s
    
                КОНТЕКСТ ЗАПРОСА ПОЛЬЗОВАТЕЛЯ:
                %s
    
                ПРАВИЛА:
                - Если контекст пустой или null → выбери любое блюдо по своему усмотрению и предложи его.
                - Если контекст есть → выбери блюдо, которое максимально соответствует желанию пользователя.
                - Совет должен быть коротким, дружелюбным и содержать рекомендацию конкретного блюда.
                - Возвращай ТОЛЬКО JSON.
                
                ФОРМАТ ОТВЕТА:
                {
                  "advice": "короткая рекомендация пользователю"
                }
    
                НЕ добавляй никаких пояснений, описаний меню или действий. Только JSON.
                """,
                menu,
                context == null ? "null" : context
        );
    }


}
